---
title: 虚拟机类加载机制
date: 2016-09-08 13:18:53
tags: 
- Java 
- JVM
categories: JVM
toc: true
---

## 类的生命周期
当启动JVM，执行Java程序时，需要加载类，作为程序的载体。它的生命周期有以下几个过程：
- 加载
- 连接(验证->准备->解析)
- 初始化
- 使用
- 卸载

由于java具有“运行时绑定”的特性，不一定都会按部就班。何时加载，虚拟机并没有特别规定。
初始化有且仅有5种情况必须对类进行初始化：
- 遇到new，getstatic，putstatic或invokestatic
- 使用java.lang.reflect包的方法对类进行反射调用
- 当初始化一个类时，父类未初始化，则触发父类初始化
- 虚拟机启动，需要指定一个要执行的主类（包含main方法的那个类）
- 使用JDK1.7的动态语言支持时，如果java.lang.invoke.MethodHandle最后的解析结果为REF_getstatic、REF_putstatic、REF_invokestatic的方法句柄，并且句柄对应的类没有进行初始化，则触发。


### 阶段:加载
此过程主要是来获取类的二进制字节流，通过class文件，jar，war，网络IO，以及动态生成。然后将字节流所代表的静态存储结构转化为方法区的运行时数据结构，最终在内存中生成代表这个类的java.lang.Class对象。

### 阶段:验证
各种验证，文件格式验证，如果魔数OXCAFEBABE，主次版本等。元数据验证，进行语义分析。字节码验证，符号引用验证。

### 阶段:准备
此过程为类变量分配内存并设置初始化（所谓的"零值"）

*注意，final static属性，不会进行初始化零值*

### 阶段:解析
将常量池内的符号引用替换
- 类或接口的解析
- 字段解析
- 类方法解析
- 接口方法解析

### 阶段：初始化
真正执行类中定义的程序代码（字节码），编译器会自动收集类中的所有变量的赋值动作和静态语句块中的语句合并产生类的<clinit>方法，在多线程环境中，虚拟机能够保证类加载被正确执行，同步。

## 类加载器

未完待续。。。